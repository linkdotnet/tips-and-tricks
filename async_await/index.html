
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A collection of tips and tricks with smaller code snippets and explanation.">
      
      
      
        <link rel="canonical" href="https://linkdotnet.github.io/tips-and-tricks/async_await/">
      
      
        <link rel="prev" href="../array/">
      
      
        <link rel="next" href="../blazor/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Async / Await - Tips and tricks</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Sora:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Sora";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#async-await" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Tips and tricks" class="md-header__button md-logo" aria-label="Tips and tricks" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tips and tricks
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Async / Await
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/linkdotnet/tips-and-tricks" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    linkdotnet/tips-and-tricks
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Tips and tricks" class="md-nav__button md-logo" aria-label="Tips and tricks" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Tips and tricks
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/linkdotnet/tips-and-tricks" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    linkdotnet/tips-and-tricks
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../array/" class="md-nav__link">
        Array
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Async / Await
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Async / Await
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#elide-await-keyword-exceptions" class="md-nav__link">
    Elide await keyword - Exceptions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elide-await-keyword-using-block" class="md-nav__link">
    Elide await keyword - using block
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return-null-task-or-taskt" class="md-nav__link">
    Return null Task or Task&lt;T&gt;
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async-void" class="md-nav__link">
    async void
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listtforeach-with-async" class="md-nav__link">
    List&lt;T&gt;.ForEach with async
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#favor-await-over-synchronous-calls" class="md-nav__link">
    Favor await over synchronous calls
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#favor-getawaitergetresult-over-wait-and-result" class="md-nav__link">
    Favor GetAwaiter().GetResult() over Wait and Result
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dont-use-taskdelay-for-small-precise-waiting-times" class="md-nav__link">
    Don't use Task.Delay for small precise waiting times
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#properly-awaiting-concurrent-tasks" class="md-nav__link">
    Properly awaiting concurrent tasks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configureawait-with-await-using-statement" class="md-nav__link">
    ConfigureAwait with await using statement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#avoid-async-in-constructors" class="md-nav__link">
    Avoid Async in Constructors
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../blazor/" class="md-nav__link">
        Blazor
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../collections/" class="md-nav__link">
        Collections
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../debugging/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../dictionary/" class="md-nav__link">
        Dictionary
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/" class="md-nav__link">
        Exceptions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../linq/" class="md-nav__link">
        LINQ
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        Misc
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../strings/" class="md-nav__link">
        Strings
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../valuetuple/" class="md-nav__link">
        ValueTuple
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_12" type="checkbox" id="__nav_12" >
      
      
      
        <label class="md-nav__link" for="__nav_12" tabindex="0" aria-expanded="false">
          Advanced
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Advanced" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          Advanced
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/" class="md-nav__link">
        Advanced
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/arraypool/" class="md-nav__link">
        ArrayPools to minimize allocations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/boxing/" class="md-nav__link">
        Boxing/Unboxing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/iterate_list/" class="md-nav__link">
        Iterate through a List<T>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/lambda_methodgroup/" class="md-nav__link">
        Lambda vs method group
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/lazy/" class="md-nav__link">
        Lazy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/SIMD/" class="md-nav__link">
        SIMD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/span/" class="md-nav__link">
        Span
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/stackalloc/" class="md-nav__link">
        stackalloc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/struct/" class="md-nav__link">
        struct
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_13" type="checkbox" id="__nav_13" >
      
      
      
        <label class="md-nav__link" for="__nav_13" tabindex="0" aria-expanded="false">
          EF Core
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="EF Core" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          EF Core
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../efcore/" class="md-nav__link">
        EF Core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../efcore/detailed_logging/" class="md-nav__link">
        Detailed Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../efcore/asnotracking/" class="md-nav__link">
        Don't track readonly entities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../efcore/maxlength_strings/" class="md-nav__link">
        Define maximum length for strings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../efcore/loadasync/" class="md-nav__link">
        LoadAsync
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../efcore/in_memory_sqlite/" class="md-nav__link">
        In Memory database with SQLite
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../efcore/retry/" class="md-nav__link">
        Retry on failure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../efcore/splitquery/" class="md-nav__link">
        SplitQuery
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_14" type="checkbox" id="__nav_14" >
      
      
      
        <label class="md-nav__link" for="__nav_14" tabindex="0" aria-expanded="false">
          Logging
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Logging" data-md-level="1">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          Logging
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../logging/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../logging/compiletime_logging/" class="md-nav__link">
        Compile-time logging source generator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../logging/string_interpolation/" class="md-nav__link">
        Don't use string interpolation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_15" type="checkbox" id="__nav_15" >
      
      
      
        <label class="md-nav__link" for="__nav_15" tabindex="0" aria-expanded="false">
          NuGet
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="NuGet" data-md-level="1">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          NuGet
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nuget/" class="md-nav__link">
        NuGet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nuget/floating_versioning/" class="md-nav__link">
        Use floating versioning
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_16" type="checkbox" id="__nav_16" >
      
      
      
        <label class="md-nav__link" for="__nav_16" tabindex="0" aria-expanded="false">
          Regular Expressions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Regular Expressions" data-md-level="1">
        <label class="md-nav__title" for="__nav_16">
          <span class="md-nav__icon md-icon"></span>
          Regular Expressions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../regex/" class="md-nav__link">
        Regular Expressions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../regex/regex_options/" class="md-nav__link">
        RegExOptions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../regex/right_to_left/" class="md-nav__link">
        Right to left search
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../regex/source_generator/" class="md-nav__link">
        Source Code Generators
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#elide-await-keyword-exceptions" class="md-nav__link">
    Elide await keyword - Exceptions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elide-await-keyword-using-block" class="md-nav__link">
    Elide await keyword - using block
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return-null-task-or-taskt" class="md-nav__link">
    Return null Task or Task&lt;T&gt;
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async-void" class="md-nav__link">
    async void
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listtforeach-with-async" class="md-nav__link">
    List&lt;T&gt;.ForEach with async
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#favor-await-over-synchronous-calls" class="md-nav__link">
    Favor await over synchronous calls
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#favor-getawaitergetresult-over-wait-and-result" class="md-nav__link">
    Favor GetAwaiter().GetResult() over Wait and Result
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dont-use-taskdelay-for-small-precise-waiting-times" class="md-nav__link">
    Don't use Task.Delay for small precise waiting times
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#properly-awaiting-concurrent-tasks" class="md-nav__link">
    Properly awaiting concurrent tasks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configureawait-with-await-using-statement" class="md-nav__link">
    ConfigureAwait with await using statement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#avoid-async-in-constructors" class="md-nav__link">
    Avoid Async in Constructors
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="async-await">async await<a class="headerlink" href="#async-await" title="Permanent link">&para;</a></h1>
<p>The following chapter will deep dive into tips, tricks and pitfalls when it comes down to <code>async</code> and <code>await</code> in C#.</p>
<h2 id="elide-await-keyword-exceptions">Elide await keyword - Exceptions<a class="headerlink" href="#elide-await-keyword-exceptions" title="Permanent link">&para;</a></h2>
<p>Eliding the await keyword can lead to a less traceable stacktrace due to the fact that every <code>Task</code> which doesn&rsquo;t get awaited, will not be part of the stack trace.</p>
<p>‚ùå <strong>Bad</strong>
<div class="highlight"><pre><span></span><code><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">try</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nf">DoWorkWithoutAwaitAsync</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">DoWorkWithoutAwaitAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nf">ThrowExceptionAsync</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">ThrowExceptionAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">Yield</span><span class="p">();</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;Hey&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></p>
<p>Will result in</p>
<div class="highlight"><pre><span></span><code>System.Exception: Hey  
 at Program.&lt;&lt;Main&gt;$&gt;g__ThrowExceptionAsync|0_1()  
 at Program.&lt;Main&gt;$(String[] args)  
</code></pre></div>
<p>‚úÖ <strong>Good</strong> If speed and allocation is not very crucial, add the <code>await</code> keyword.
<div class="highlight"><pre><span></span><code><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">try</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nf">DoWorkWithoutAwaitAsync</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">DoWorkWithoutAwaitAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nf">ThrowExceptionAsync</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">ThrowExceptionAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">Yield</span><span class="p">();</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;Hey&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></p>
<p>Will result in:
<div class="highlight"><pre><span></span><code>System.Exception: Hey
   at Program.&lt;&lt;Main&gt;$&gt;g__ThrowExceptionAsync|0_1()
   at Program.&lt;&lt;Main&gt;$&gt;g__DoWorkWithoutAwaitAsync|0_0()
   at Program.&lt;Main&gt;$(String[] args)
</code></pre></div></p>
<blockquote>
<p>üí° Info: Eliding the <code>async</code> keyword will also elide the whole state machine. In very hot paths that might be worth a consideration. In normal cases one should not elide the keyword. The allocations one is saving is depending on the circumstances but a normally very very small especially if only smaller objects are passed around. Also performance-wise there is no big gain when eliding the keyword (we are talking nano seconds). Please measure first and act afterwards.</p>
</blockquote>
<h2 id="elide-await-keyword-using-block">Elide await keyword - using block<a class="headerlink" href="#elide-await-keyword-using-block" title="Permanent link">&para;</a></h2>
<p>Eliding inside an <code>using</code> block can lead to a disposed object before the <code>Task</code> is finished.</p>
<p>‚ùå <strong>Bad</strong> Here the download will be aborted / the <code>HttpClient</code> gets disposed:
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetContentFromUrlAsync</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="nn">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpClient</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></p>
<p>‚úÖ <strong>Good</strong>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetContentFromUrlAsync</span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="nn">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpClient</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">GetStringAsync</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></p>
<blockquote>
<p>üí° Info: Eliding the <code>async</code> keyword will also elide the whole state machine. In very hot paths that might be worth a consideration. In normal cases one should not elide the keyword. The allocations one is saving is depending on the circumstances but a normally very very small especially if only smaller objects are passed around. Also performance-wise there is no big gain when eliding the keyword (we are talking nano seconds). Please measure first and act afterwards.</p>
</blockquote>
<h2 id="return-null-task-or-taskt">Return <code>null</code> <code>Task</code> or <code>Task&lt;T&gt;</code><a class="headerlink" href="#return-null-task-or-taskt" title="Permanent link">&para;</a></h2>
<p>When returning directly <code>null</code> from a synchronous call (no <code>async</code> or <code>await</code>) will lead to <code>NullReferenceException</code>:</p>
<p>‚ùå <strong>Bad</strong> Will throw <code>NullReferenceException</code>
<div class="highlight"><pre><span></span><code><span class="k">await</span><span class="w"> </span><span class="nf">GetAsync</span><span class="p">();</span>

<span class="k">static</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></p>
<p>‚úÖ <strong>Good</strong> Use <code>Task.FromResult</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">await</span><span class="w"> </span><span class="nf">GetAsync</span><span class="p">();</span>

<span class="k">static</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="async-void"><code>async void</code><a class="headerlink" href="#async-void" title="Permanent link">&para;</a></h2>
<p>The problem with <code>async void</code> is first they are not awaitable and second they suffer the same problem with exceptions and stack trace as discussed a bit earlier. It is basically fire and forget.</p>
<p>‚ùå <strong>Bad</strong> Not awaited
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">DoAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nf">SomeAsyncOp</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></p>
<p>‚úÖ <strong>Good</strong> return <code>Task</code> instead of <code>void</code>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">DoAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nf">SomeAsyncOp</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></p>
<blockquote>
<p>üí° Info: There are valid cases for <code>async void</code> like top level event handlers.</p>
</blockquote>
<h2 id="listtforeach-with-async"><code>List&lt;T&gt;.ForEach</code> with <code>async</code><a class="headerlink" href="#listtforeach-with-async" title="Permanent link">&para;</a></h2>
<p><code>List&lt;T&gt;.ForEach</code> and in general a lot of LINQ methods don&rsquo;t go well with <code>async</code> <code>await</code>:</p>
<p>‚ùå <strong>Bad</strong> Is the same as <code>async void</code>
<div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="n">ids</span><span class="p">.</span><span class="n">ForEach</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_myRepo</span><span class="p">.</span><span class="n">UpdateAsync</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
</code></pre></div></p>
<p>One could thing adding <code>async</code> into the lamdba would do the trick:</p>
<p>‚ùå <strong>Bad</strong> Still the same as <code>async void</code> because <code>List&lt;T&gt;.ForEach</code> takes an <code>Action</code> and not a <code>Func&lt;Task&gt;</code>.
<div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="n">ids</span><span class="p">.</span><span class="n">ForEach</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_myRepo</span><span class="p">.</span><span class="n">UpdateAsync</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
</code></pre></div></p>
<p>‚úÖ <strong>Good</strong> Enumerate through the list via <code>foreach</code>
<div class="highlight"><pre><span></span><code><span class="k">foreach</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ids</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="n">_myRepo</span><span class="p">.</span><span class="n">UpdateAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></p>
<h2 id="favor-await-over-synchronous-calls">Favor <code>await</code> over synchronous calls<a class="headerlink" href="#favor-await-over-synchronous-calls" title="Permanent link">&para;</a></h2>
<p>Using blocking calls instead of <code>await</code> can lead to potential deadlocks and other side effects like a poor stack trace in case of an exception and less scalability in web frameworks like ASP.NET core.</p>
<p>‚ùå <strong>Bad</strong> This call blocks the thread.
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">SomeOperationAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="p">...</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Do</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">SomeOperationAsync</span><span class="p">().</span><span class="n">Wait</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></p>
<p>‚úÖ <strong>Good</strong> Use <code>async</code> &amp; <code>await</code> in the whole chain
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">SomeOperationAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="p">...</span>
<span class="p">}</span>

<span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">Do</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nf">SomeOperationAsync</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></p>
<h2 id="favor-getawaitergetresult-over-wait-and-result">Favor <code>GetAwaiter().GetResult()</code> over <code>Wait</code> and <code>Result</code><a class="headerlink" href="#favor-getawaitergetresult-over-wait-and-result" title="Permanent link">&para;</a></h2>
<p><code>Task.GetAwaiter().GetResult()</code> is preferred over <code>Task.Wait</code> and <code>Task.Result</code> because it propagates exceptions rather than wrapping them in an AggregateException. </p>
<p>‚ùå <strong>Bad</strong>
<div class="highlight"><pre><span></span><code><span class="kt">string</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DownloadAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>
</code></pre></div></p>
<p>‚úÖ <strong>Good</strong> 
<div class="highlight"><pre><span></span><code><span class="kt">string</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DownloadAsync</span><span class="p">().</span><span class="n">GetAwaiter</span><span class="p">().</span><span class="n">GetResult</span><span class="p">();</span>
</code></pre></div></p>
<h2 id="dont-use-taskdelay-for-small-precise-waiting-times">Don&rsquo;t use <code>Task.Delay</code> for small precise waiting times<a class="headerlink" href="#dont-use-taskdelay-for-small-precise-waiting-times" title="Permanent link">&para;</a></h2>
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.delay?view=net-6.0#System_Threading_Tasks_Task_Delay_System_Int32_"><code>Task.Delay</code></a>&lsquo;s internal timer is dependent on the underlying OS. On most windows machines this resolution is about 15ms.</p>
<p>So: <code>Task.Delay(1)</code> will not wait one millisecond but something between one and 15 milliseconds.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">stopwatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stopwatch</span><span class="p">.</span><span class="n">StartNew</span><span class="p">();</span>
<span class="k">await</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
<span class="n">stopwatch</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span><span class="w"> </span><span class="c1">// Don&#39;t account the Console.WriteLine into the timer</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&quot;Delay was {stopwatch.ElapsedMilliseconds} ms&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Will print for example:</p>
<blockquote>
<p>Delay was 6 ms</p>
</blockquote>
<h2 id="properly-awaiting-concurrent-tasks">Properly awaiting concurrent tasks<a class="headerlink" href="#properly-awaiting-concurrent-tasks" title="Permanent link">&para;</a></h2>
<p>Often times tasks are independent of each other and can be awaited independently.</p>
<p>‚ùå <strong>Bad</strong> The following code will run roughly 1 second.
<div class="highlight"><pre><span></span><code><span class="k">await</span><span class="w"> </span><span class="nf">DoOperationAsync</span><span class="p">();</span>
<span class="k">await</span><span class="w"> </span><span class="nf">DoOperationAsync</span><span class="p">();</span>

<span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">DoOperationAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div></p>
<p>‚úÖ <strong>Good</strong> When tasks or their data is independent they can be awaited independently for maximum benefits. The following code will run roughly 0.5 seconds.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DoOperationAsync</span><span class="p">();</span>
<span class="kt">var</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DoOperationAsync</span><span class="p">();</span>
<span class="k">await</span><span class="w"> </span><span class="n">t1</span><span class="p">;</span>
<span class="k">await</span><span class="w"> </span><span class="n">t2</span><span class="p">;</span>

<span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">DoOperationAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<p>An alternative to this would be <a href="https://docs.microsoft.com/en-us/documentation/"><code>Task.WhenAll</code></a>:
<div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DoOperationAsync</span><span class="p">();</span>
<span class="kt">var</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DoOperationAsync</span><span class="p">();</span>
<span class="k">await</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">WhenAll</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">);</span><span class="w"> </span><span class="c1">// Can also be inlined</span>

<span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">DoOperationAsync</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div></p>
<h2 id="configureawait-with-await-using-statement"><code>ConfigureAwait</code> with <code>await using</code> statement<a class="headerlink" href="#configureawait-with-await-using-statement" title="Permanent link">&para;</a></h2>
<p>Since C# 8 you can provide an <code>IAsyncDisposable</code> which allows to have asynchrnous code in the <code>Dispose</code> method. Also this allows to call the following construct:</p>
<div class="highlight"><pre><span></span><code><span class="k">await</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="nn">var</span><span class="w"> </span><span class="n">dbContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">dbContextFactory</span><span class="p">.</span><span class="n">CreateDbContextAsync</span><span class="p">().</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</code></pre></div>
<p>In this example <code>CreateDbContextAsync</code> uses the <code>ConfigureAwait(false)</code> but <strong>not</strong> the <code>IAsyncDisposable</code>. To make that work we have to break apart the statment like this:</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">dbContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">dbContextFactory</span><span class="p">.</span><span class="n">CreateDbContextAsync</span><span class="p">().</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="k">await</span><span class="w"> </span><span class="nf">using</span><span class="w"> </span><span class="p">(</span><span class="n">dbContext</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>The last part has the &ldquo;ugly&rdquo; snippet that you have to introduce a new &ldquo;block&rdquo; for the <code>using</code> statement. For that there is a easy workaround:
<div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">blogDbContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">dbContextFactory</span><span class="p">.</span><span class="n">CreateDbContextAsync</span><span class="p">().</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="k">await</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="nn">var</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blogDbContext</span><span class="p">.</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="c1">// You don&#39;t need the {} block here</span>
</code></pre></div></p>
<h2 id="avoid-async-in-constructors">Avoid Async in Constructors<a class="headerlink" href="#avoid-async-in-constructors" title="Permanent link">&para;</a></h2>
<p>Constructors are meant to initialize objects synchronously, as their primary purpose is to set up the initial state of the object. When you need to perform asynchronous operations during object initialization, using async methods in constructors can lead to issues such as deadlocks or incorrect object initialization. Instead, use a static asynchronous factory method or a separate asynchronous initialization method to ensure safe and proper object initialization.</p>
<p>Using async operations in constructors can be problematic for several reasons like <strong>Deadlocks</strong>, <strong>Incomplete Initialization</strong>, and <strong>Exception Handling</strong>.</p>
<p>‚ùå <strong>Bad</strong> Calling async methods in constructors</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">MyClass</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">InitializeAsync</span><span class="p">().</span><span class="n">GetAwaiter</span><span class="p">().</span><span class="n">GetResult</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">InitializeAsync</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">LoadDataAsync</span><span class="p">();</span>
</code></pre></div>
<p>‚úÖ <strong>Good</strong>: Option 1 - Static asynchronous factory method:</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nf">MyClass</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CreateAsync</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyClass</span><span class="p">();</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">InitializeAsync</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">InitializeAsync</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">LoadDataAsync</span><span class="p">();</span>
</code></pre></div>
<p>‚úÖ <strong>Good</strong>: Option 2 - Separate asynchronous initialization method:</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">InitializeAsync</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">LoadDataAsync</span><span class="p">();</span>
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2022 <a href="https://github.com/linkdotnet">Steven Giesel</a>.
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://www.linkedin.com/in/steven-giesel/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/linkdotnet" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://steven-giesel.com/" target="_blank" rel="noopener" title="steven-giesel.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M0 64c0-17.7 14.3-32 32-32 229.8 0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7 0 64zm128 352c0 35.3-28.7 64-64 64S0 451.3 0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1 0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7 0-32-14.3-32-32s14.3-32 32-32z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
    
  </body>
</html>